# Глава 2. Tla+ cпецификации

Для проверки корректности алгоритма репликации движков необходимо написать спецификацию на TLA+. В введении было сказано про проблемы у спецификаций и соответствующих им TLC моделей. Во-первых, описание системы на языке TLA+ может быть слишком абстрактным и не похожим на реальный код. Во-вторых граф состояний в TLC модели может быть слишком большим из-за, наоборот, очень подробной модели. Поэтому хочется написать 2 спецификации, детальную для большего соответствия коду, и абстрактную, для проверки свойств.

## 2.1. Различия спецификаций

Хочется, чтобы абстрактная модель задавала то, что происходит в системе. Например, мастер добавляет новый запрос пользователя, реплика копирует с мастера этот запрос, или нода становится лидером, выбирая лучшую цепочку. А детальная спецификация должна показывать то, как это происходит. Одна декларативно описывает "что", вторая описывает "как".

Основная идея состоит в том, чтобы в абстрактной спецификации не было сообщений между репликами, а в детальной они были. Тогда в первой переменные с состояними машин будут обмениваться значениями друг с другом - реплики копировать лог мастера, например - а вторая будет отвечать на вопрос, как они это делают - через сообщения.

## 2.2 Абстрактная спецификация

Вначале приведу абстрактную спецификацию.

## 2.2.1 Переменные асбтрактной спецификации

В TLA+ есть константы и переменные. Константы задаются для модели извне и не меняются для всего графа состояний. А значения переменных, наоборот, позволяют различить вершины графа. Они меняются в переходах, разрешённых в модели.

```
Листинг 1 - переменные абстрактной спецификации

CONSTANTS Replica, Quorum

\* Replica Status
CONSTANTS Normal, ViewChange, Recovering

\* Client operation
CONSTANT Operation

\* types of log blocks
CONSTANTS RequestBlock, ViewBlock

\* State on each replica
VARIABLE replicaState

vars == <<replicaState>>

\* Special value
CONSTANT None

\* Sequence with all replicas (for view selection)
CONSTANT ReplicaSequence

```

Переменные абстрактной модели представлены на листинге 1.
