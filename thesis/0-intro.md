# Введение

Во внутренней инфраструктуре VK используются движки для хранения картинок, сообщений и многих других видов контента. **TODO** описать подробнее, почитав статьи от самих разрабов ВК...

Движки расположены на разных виртуальных или железных машинах. У них могут случаться отказы. И необходимо поддерживать сохранность и консистентность данных в случае разных сбоев в работе машин и сети, иначе пользователи потеряют свои сообщения или купленные предметы в социальной сети, например.

Всё это является типичной задачи репликации лога и решается алгоритмами распределённого консенсуса: Paxos, Raft, Viewstamped Replication. Последний вариант был взят за основу собственного алгоритма в VK.

Для автоматической проверки корректности написанного кода применяются различные методы - тесты, фазеры. Но они не дают формального доказательства и не позволяют быть полностью уверенным в правильности реализованного алгоритма.

Существуют методы и инструменты формальной верификации распределённых систем и параллельных алгоритмов. Один из самых популярных - язык TLA+ и инструмент TLC для него. На языке TLA+ можно высокоуровнево описывать алгоритм или систему - составлять TLA+ спецификацию. А с помощью TLC можно строить модель по ней и проверять выполнение требуемых свойств, которыми должна обладать система. Такая техника более отдалена от кода, чем тесты и фазеры, однако автоматически проверяет все возможные исполнения - не только случайно сгенерённые фазером или описанные в сценариях тестов.

В спецификации на языке TLA+ описывается некая абстрактная модель мира, в котором работает система. Делается это через переменные, описывающих, например, мета информацию на репликах, журнал лога на каждой из них или множество посланных сообщений в сети. Множество значений всех переменных в один момент времени - это одно состояние. В спецификации перечисляются возможные события, меняющие их значение, например, получение сообщения на реплике, приём запроса от клиента или падение машины.

А инструмент TLC model checker строит по этим переменным и событиям ориентированный граф, в котором вершинам соответствуют состояния, а рёбрам между ними - возможные переходы, описанные в спецификации на TLA+. Для каждой вершины проверяются инварианты модели - например, консистентность закомиченных элементов лога или единственность лидера в одних выборах.

Существуют сложности, связанные с этими моделями. Из-за большой детализации граф состояний может быть очень большой и проверки на нём слишком долгими. Это бывает, если описывать в модели много деталей реализации, лишних переменных, из-за которых граф будет экспоненциально разрастаться.

А с другой стороны спецификация на TLA+ может быть слишком абстрактной, из-за чего инженерам может быть сложно убедиться, что она соответсвует реальному коду или алгоритму. Это бывает, если, наоборот, упрощать модель и упускать детали. То есть эти проблемы двойственны.

Для этого Лесли Лампорт добавил в TLA+ возможность имплементирования спецификаций. Одна модель может реализовывать другую - если во время исполнения одной корректно выполняются шаги и в другой. Поскольку это является логической импликацией, то по транзитивности первая спецификация наследует свойства второй и их можно отдельно не проверять.

Спецификации, предлагаемые в данной работе, проверены на корректность на некоторых ограниченных пространствах состояний. Кроме того, детализированная спецификация корректно реализует абстрактную. Благодаря этому модель можно изучать, начиная с абстрактной, постепенно переходя на более детализированную.
