# Глава 1. Алгоритм в Базе Данных ВК

# 1.1. Viewstamped Replication

За основу алгоритма разработчиками была взята статья про Viewstamped Replication. Авторы статьи предлагают отказоустойчивый алгоритм в том смысле, что он будет корректно работать, даже когда упадут не более `f` машин, если всего есть `2 * f + 1` реплик.

# 1.1.1. Хранимое состояние на репликах

На репликах хранится топология кластера (упорядоченный список всех нод), номер данной реплики, текущий номер view (+- номер последнего голосования), текущий статус реплики (Normal, ViewChanging или Recovering), журнал лога и commit number. Это всё, что важно в данной работе. Порядок реплик в списке важен и должен быть одинаков на всех - именно в этом порядке выбираются лидеры в голосованиях. Например, в случае 3 реплик, первая будет лидером во всех view с номерами 0, 3, 6, вторая - в 1, 4, 7 и так далее. Журнал лога должен храниться в энергонезависимой памяти, чтобы не теряться в случае отказа узла.

# 1.1.1. Normal Operation Protocol

Когда реплика, считающая себя лидером, получает запрос от клиента, она добавляет его в конец лога и отсылает всем репликам сообщение типа Prepare. Нода, получившая актуальный Prepare, тоже добавляет запрос в лог и отсылает лидеру в ответ PrepareOk.

Как только лидер набирает кворум ответов (`f + 1`), включая себя, он считает операцию закоммиченной и увеличивает commit number. Поскольку в данный момент более, чем на половине реплик есть клиентский запрос, то он никуда не потеряется, даже если сеть отрежет текущего мастера или часть реплик, или если мастер упадёт. Следующий лидер точно получит от кого-то этот запрос.

Так же мастер периодически отсылает репликам Commit сообщение для того, чтобы все могли закоммитить и исполнить операцию, а так же, чтобы ноды узнавали, что мастер жив и не запускали новое голосование.

# 1.1.1. View Change Protocol

Если же у кого из реплик сработал таймер на голосование, то реплика переходит в статус ViewChange, увеличивает view и отсылает всем сообщение StartViewChanging. Другая реплика может получить это сообщение и сделать то же самое. Итого все реплики, перходящие в фазу смены лидера, отсылают всем StartViewChange. 

# 1.2. Оптимизации в Базе Даных ВК
